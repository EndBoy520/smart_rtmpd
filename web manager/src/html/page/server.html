<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>服务管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <style>
        .layui-elem-field {margin-top: 20px; padding-top: 20px;}
        .layui-form-label {width: 100px;}
        .layui-input-block {margin-left: 130px;}
        .layui-form-text {
            float: left;
            display: block;
            padding: 6px 0;
            font-weight: 400;
            line-height: 20px;
            text-align: right;
        }
        .layui-form-text .layui-badge {
            padding: 3px 6px;
        }
        .layui-bg-gray {
            min-width: 30px;
        }
        .layui-inline-mark {
            display: inline-block;
            width: 105px;
        }
        @media screen and (max-width: 450px){
            .layui-elem-field {
                margin-top: 1px;
                padding-top: 1px;
            }
            .layui-form-item .layui-form-text {
                width: auto!important;
            }
            .layui-btn+.layui-btn {
                margin-left: 4px;
            }
            .layui-input-block {
                margin-left: 0px;
                text-align: center;
            }
            .layui-inline-mark {
                display: none;
            }
        }
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">

        <form class="layui-form" action="" lay-filter="server">
            <fieldset class="layui-elem-field">
                <legend class="i18n" data-lang="menu_server">服务管理</legend>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_start_time">启动时间：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray start_time"></span>
                        </div>
                    </div>
                    <div class="layui-inline-mark"></div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_status">服务状态：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge server_run"></span>
                        </div>
                    </div>
                </div>

                <fieldset class="layui-elem-field layui-field-title">
                    <legend>RTMP</legend>
                </fieldset>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_rtmp_port">RTMP 端口：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray rtmp_port"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_rtmp_ssl">SSL：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge rtmp_ssl"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_rtmp_run">状态：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge rtmp_run"></span>
                        </div>
                    </div>
                </div>

                <fieldset class="layui-elem-field layui-field-title">
                    <legend>RTSP</legend>
                </fieldset>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_rtsp_port">RTSP 端口：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray rtsp_port"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_rtsp_ssl">SSL：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge rtsp_ssl"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_rtsp_run">状态：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge rtsp_run"></span>
                        </div>
                    </div>
                </div>
                
                <fieldset class="layui-elem-field layui-field-title">
                    <legend>HTTP</legend>
                </fieldset>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_http_port">HTTP 端口：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray http_port"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_http_ssl">SSL：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge http_ssl"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_http_run">状态：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge http_run"></span>
                        </div>
                    </div>
                    <div class="layui-inline http-sport">
                        <label class="layui-form-label i18n" data-lang="server_http_sport">HTTPS 端口：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray http_sport"></span>
                        </div>
                    </div>
                </div>

                <fieldset class="layui-elem-field layui-field-title">
                    <legend>SRT</legend>
                </fieldset>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_srt_port">SRT 端口：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray srt_port"></span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_srt_ssl">SSL：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge layui-bg-gray srt_ssl">未开启</span>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label i18n" data-lang="server_srt_run">状态：</label>
                        <div class="layui-form-text">
                            <span class="layui-badge srt_run"></span>
                        </div>
                    </div>
                </div>
                
            </fieldset>
            <div class="layui-form-item margin-top-20">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn btn-onoff">启动</button>
                    <button type="button" class="layui-btn layui-btn-normal btn-restart i18n" data-lang="server_restart">重启</button>
                    <button type="button" class="layui-btn btn-refresh">
                        <!-- <i class="fa fa-refresh margin-right-10"></i> -->
                        <span class="i18n" data-lang="common_refresh">刷新</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=2.0.0" charset="utf-8"></script>
<script src="../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="../js/jquery.i18n.properties-min-1.0.9.js" charset="utf-8"></script>
<script src="../js/common.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'jquery', 'request'], function() {
        var $ = layui.jquery,
            form = layui.form,
            layer = layui.layer,
            request = layui.request;

        window.lang.render(); // 国际化

        // 刷新按钮
        $('.btn-refresh').on('click', function() {
            getServerInfo(); // 获取服务状态信息
        });

        // 启动停止按钮
        $('.btn-onoff').on('click', function() {
            let status = $('.start_time').text();

            layer.confirm('本项操作会'+ (window.lang.map.common_status ? window.lang.map.common_stop : window.lang.map.common_start) +'服务，是否继续？', {
                btn: [window.lang.map.common_enter, window.lang.map.common_cancel]
            }, function(){
                request.post({
                    url: status ? '/stop' : '/start',
                    success: function(res) {
                        let { code, msg, data } = res;
                        if (code === 0) {
                            layer.msg(msg);
                            if (status) {
                                $('input[name="start_time"]').val('');
                                
                                $('.btn-onoff').removeClass('layui-btn-danger').text(window.lang.map.common_start);
                                $('input[name="server_run"]').prop('checked', false);
                                form.render('checkbox');
                            } else {
                                $('.btn-onoff').addClass('layui-btn-danger').text(window.lang.map.common_stop);
                                $('input[name="server_run"]').prop('checked', true);
                                form.render('checkbox');
                            }
                            getServerInfo(); // 获取服务状态信息
                        } else {
                            layer.msg(JSON.stringify(msg));
                        }
                    }
                });
            });
        });

        // 重启按钮
        $('.btn-restart').on('click', function() {
            layer.confirm(window.lang.map.server_tips_restart, {
                btn: [window.lang.map.common_enter, window.lang.map.common_cancel]
            }, function(){
                request.post({
                    url: '/restart',
                    success: function(res) {
                        let { code, msg, data } = res;
                        if (code === 0) {
                            layer.msg(msg);
                            getServerInfo(); // 获取服务状态信息
                        } else {
                            layer.msg(JSON.stringify(msg));
                        }
                    }
                });
            });
        });

        // 获取服务状态信息
        function getServerInfo() {
            request.get({
                url: '/service',
                success: function(res) {
                    let { code, msg, data } = res;
                    if (code === 0) {

                        $('.start_time').text(data.start_time);
                        $('.server_run').text(data.start_time ? window.lang.map.common_run : window.lang.map.common_stop).addClass(data.start_time ? 'layui-bg-green' : '');

                        $('.rtmp_port').text(data.rtmp.port);
                        $('.rtmp_ssl').text(data.rtmp.ssl ? window.lang.map.common_on : window.lang.map.common_off).addClass(data.rtmp.ssl ? 'layui-bg-gray' : 'layui-bg-gray');
                        $('.rtmp_run').text(data.rtmp.run ? window.lang.map.common_run : window.lang.map.common_stop).addClass(data.rtmp.run ? 'layui-bg-green' : '');

                        $('.rtsp_port').text(data.rtsp.port);
                        $('.rtsp_ssl').text(data.rtsp.ssl ? window.lang.map.common_on : window.lang.map.common_off).addClass(data.rtsp.ssl ? 'layui-bg-gray' : 'layui-bg-gray');
                        $('.rtsp_run').text(data.rtsp.run ? window.lang.map.common_run : window.lang.map.common_stop).addClass(data.rtsp.run ? 'layui-bg-green' : '');

                        $('.http_port').text(data.http.port);
                        $('.http_ssl').text(data.http.ssl ? window.lang.map.common_on : window.lang.map.common_off).addClass(data.http.ssl ? 'layui-bg-gray' : 'layui-bg-gray');
                        $('.http_run').text(data.http.run ? window.lang.map.common_run : window.lang.map.common_stop).addClass(data.http.run ? 'layui-bg-green' : '');
                        $('.http_ports').text(data.http.ports);

                        if (data.http.ssl === false) {
                            $('.http-sport').hide();
                        }

                        $('.srt_port').text(data.srt.port);
                        $('.srt_ssl').text(window.lang.map.common_off);
                        $('.srt_run').text(data.srt.run ? window.lang.map.common_run : window.lang.map.common_stop).addClass(data.srt.run ? 'layui-bg-green' : '');

                        if (data.start_time) {
                            $('.btn-onoff').addClass('layui-btn-danger').text(window.lang.map.common_stop);
                            $('input[name="server_run"]').prop('checked', true);
                            form.render('checkbox');
                        } else {
                            $('.btn-onoff').removeClass('layui-btn-danger').text(window.lang.map.common_start);
                            $('input[name="server_run"]').prop('checked', false);
                            form.render('checkbox');
                        }

                        window.lang.render(); // 国际化
                    } else {
                        layer.msg(JSON.stringify(msg));
                    }
                }
            });
        }
        getServerInfo(); // 获取服务状态信息

    });
</script>
</body>
</html>